# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨æ‰‹é †æ›¸

**ã‚¿ã‚¤ãƒˆãƒ«**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨æ‰‹é †æ›¸  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0  
**æœ€çµ‚æ›´æ–°æ—¥**: YYYY-MM-DD  
**ä½œæˆè€…**: [ä½œæˆè€…å]  
**ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: [ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å]  
**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: security-design.md, incident-response-procedures.md  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: draft  

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„
æœ¬æ–‡æ›¸ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®æ—¥å¸¸çš„ãªé‹ç”¨æ‰‹é †ã‚’å®šç¾©ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®äºˆé˜²ã¨æ—©æœŸç™ºè¦‹ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚

### 1.2 é©ç”¨ç¯„å›²
æœ¬æ‰‹é †ã¯ã€ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨ã«é©ç”¨ã•ã‚Œã‚‹ï¼š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ»åˆ†æ
- è„†å¼±æ€§ç®¡ç†
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç®¡ç†
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²ãƒ»è¨“ç·´

### 1.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨æ–¹é‡
- **ç¶™ç¶šç›£è¦–**: 24æ™‚é–“365æ—¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–
- **äºˆé˜²é‡è¦–**: äº‹å‰é˜²å¾¡ã«ã‚ˆã‚‹è¢«å®³æœ€å°åŒ–
- **è¿…é€Ÿå¯¾å¿œ**: ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®ç´ æ—©ã„åˆå‹•å¯¾å¿œ
- **ç¶™ç¶šæ”¹å–„**: è„…å¨å‹•å‘ã«å¿œã˜ãŸå¯¾ç­–ç¶™ç¶šçš„æ”¹å–„

## 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ä½“åˆ¶

### 2.1 ç›£è¦–ä½“åˆ¶

#### 2.1.1 å½¹å‰²åˆ†æ‹…

| å½¹å‰² | è²¬ä»»è€… | ä¸»ãªæ¥­å‹™ | å‹¤å‹™æ™‚é–“ |
|---|---|---|---|
| **CISO** | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²¬ä»»è€… | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æˆ¦ç•¥ãƒ»æ„æ€æ±ºå®š | å–¶æ¥­æ™‚é–“ |
| **SOCã‚¢ãƒŠãƒªã‚¹ãƒˆ** | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚é–€å®¶ | é«˜åº¦åˆ†æãƒ»ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ | 24æ™‚é–“ä½“åˆ¶ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢** | æŠ€è¡“æ‹…å½“è€… | æŠ€è¡“çš„å¯¾å¿œãƒ»è¨­å®šå¤‰æ›´ | å–¶æ¥­æ™‚é–“+ã‚ªãƒ³ã‚³ãƒ¼ãƒ« |
| **é‹ç”¨ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢** | é‹ç”¨æ‹…å½“è€… | åŸºæœ¬ç›£è¦–ãƒ»ä¸€æ¬¡å¯¾å¿œ | 24æ™‚é–“ä½“åˆ¶ |

#### 2.1.2 ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Level 1         â”‚ â† ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ï¼ˆå³åº§ï¼‰
â”‚ é‹ç”¨ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 15åˆ†ä»¥å†…/é‡è¦åº¦Highä»¥ä¸Š
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Level 2         â”‚ â† è©³ç´°åˆ†æãƒ»å¯¾å¿œåˆ¤æ–­ï¼ˆ30åˆ†ä»¥å†…ï¼‰
â”‚ SOCã‚¢ãƒŠãƒªã‚¹ãƒˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1æ™‚é–“ä»¥å†…/Critical
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Level 3         â”‚ â† çµŒå–¶åˆ¤æ–­ãƒ»å¯¾å¤–å¯¾å¿œï¼ˆå³åº§ï¼‰
â”‚ CISO            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›£è¦–å¯¾è±¡ãƒ»é …ç›®

#### 2.2.1 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–

**ç›£è¦–é …ç›®**
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
- DDoSæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
- ç•°å¸¸ãªé€šä¿¡é‡ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³
- æœªæ‰¿èªã®é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

**ç›£è¦–ãƒ„ãƒ¼ãƒ«è¨­å®š**
```bash
# Suricata IDSè¨­å®šä¾‹
# /etc/suricata/suricata.yaml

default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules
  - emerging-threats.rules
  - local.rules

# ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ä¾‹ï¼ˆ/var/lib/suricata/rules/local.rulesï¼‰
alert tcp any any -> $HOME_NET 22 (msg:"SSH Brute Force Attempt"; 
    flow:to_server,established; content:"SSH"; threshold:type both,track by_src,count 5,seconds 60; 
    sid:1000001; rev:1;)

alert http any any -> $HOME_NET any (msg:"SQL Injection Attempt"; 
    flow:to_server,established; content:"union select"; nocase; 
    sid:1000002; rev:1;)
```

#### 2.2.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–

**ç›£è¦–é …ç›®**
- èªè¨¼å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³
- ç•°å¸¸ãªAPIã‚¢ã‚¯ã‚»ã‚¹
- æ¨©é™æ˜‡æ ¼è©¦è¡Œ
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç•°å¸¸

```python
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ä¾‹
import logging
from collections import defaultdict
from datetime import datetime, timedelta

class SecurityMonitor:
    def __init__(self):
        self.failed_logins = defaultdict(list)
        self.api_requests = defaultdict(list)
        
    def monitor_login_attempts(self, username, ip_address, success):
        """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®ç›£è¦–"""
        current_time = datetime.now()
        
        if not success:
            self.failed_logins[ip_address].append(current_time)
            
            # 5åˆ†é–“ã«5å›å¤±æ•—ã—ãŸå ´åˆã‚¢ãƒ©ãƒ¼ãƒˆ
            recent_failures = [t for t in self.failed_logins[ip_address] 
                             if current_time - t < timedelta(minutes=5)]
            
            if len(recent_failures) >= 5:
                self.alert_brute_force(username, ip_address)
                
    def monitor_api_access(self, user_id, endpoint, method):
        """API ã‚¢ã‚¯ã‚»ã‚¹ç›£è¦–"""
        current_time = datetime.now()
        self.api_requests[user_id].append({
            'time': current_time,
            'endpoint': endpoint,
            'method': method
        })
        
        # 1åˆ†é–“ã«100ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»¥ä¸Šã®å ´åˆã‚¢ãƒ©ãƒ¼ãƒˆ
        recent_requests = [r for r in self.api_requests[user_id]
                          if current_time - r['time'] < timedelta(minutes=1)]
        
        if len(recent_requests) >= 100:
            self.alert_api_abuse(user_id)
            
    def alert_brute_force(self, username, ip_address):
        """ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚¢ãƒ©ãƒ¼ãƒˆ"""
        logging.critical(f"Brute force attack detected: {username} from {ip_address}")
        # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡å‡¦ç†
        
    def alert_api_abuse(self, user_id):
        """APIä¹±ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ"""
        logging.warning(f"API abuse detected: User {user_id}")
        # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡å‡¦ç†
```

#### 2.2.3 ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

**ç›£è¦–é …ç›®**
- ç®¡ç†è€…æ¨©é™ã§ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
- é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´
- ç•°å¸¸ãªãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
- ä¸å¯©ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š

```bash
# auditd è¨­å®šä¾‹ï¼ˆ/etc/audit/rules.d/security.rulesï¼‰

# é‡è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›£è¦–
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/ssh/sshd_config -p wa -k ssh_config_changes
-w /opt/application/config -p wa -k app_config_changes

# ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ã®ç›£è¦–
-w /bin/su -p x -k su_usage
-w /bin/sudo -p x -k sudo_usage
-w /usr/bin/passwd -p x -k passwd_usage

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šå¤‰æ›´ã®ç›£è¦–
-w /etc/hosts -p wa -k network_changes
-w /etc/resolv.conf -p wa -k dns_changes

# ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ç›£è¦–
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
-a always,exit -F arch=b64 -S clock_settime -k time_change
```

## 3. æ—¥å¸¸ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨

### 3.1 æ—¥æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

#### 3.1.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°åˆ†æï¼ˆæ¯æ—¥ 9:00ï¼‰

```bash
#!/bin/bash
# daily_security_check.sh

LOG_DATE=$(date +%Y%m%d)
REPORT_FILE="/var/log/security/daily_report_$LOG_DATE.txt"

echo "=== æ—¥æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ $(date) ===" > $REPORT_FILE

# 1. èªè¨¼ãƒ­ã‚°åˆ†æ
echo "## èªè¨¼é–¢é€£" >> $REPORT_FILE
echo "### ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—" >> $REPORT_FILE
grep "Failed password" /var/log/auth.log | grep "$(date +%b' '%d)" | \
    awk '{print $11}' | sort | uniq -c | sort -nr >> $REPORT_FILE

echo "### ä¸æ­£ãƒ¦ãƒ¼ã‚¶ãƒ¼è©¦è¡Œ" >> $REPORT_FILE
grep "Invalid user" /var/log/auth.log | grep "$(date +%b' '%d)" | \
    awk '{print $8, $10}' | sort | uniq -c | sort -nr >> $REPORT_FILE

# 2. Web ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åˆ†æ
echo "## Webã‚¢ã‚¯ã‚»ã‚¹é–¢é€£" >> $REPORT_FILE
echo "### 4xx/5xx ã‚¨ãƒ©ãƒ¼" >> $REPORT_FILE
awk '$9>=400 {print $1, $7, $9}' /var/log/nginx/access.log | \
    grep "$(date +%d/%b/%Y)" | sort | uniq -c | sort -nr | head -20 >> $REPORT_FILE

echo "### ä¸å¯©ãªUser-Agent" >> $REPORT_FILE
grep -E "(bot|crawler|scanner)" /var/log/nginx/access.log | \
    grep "$(date +%d/%b/%Y)" | awk '{print $1, $12}' | sort | uniq -c | sort -nr >> $REPORT_FILE

# 3. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°åˆ†æ
echo "## ã‚·ã‚¹ãƒ†ãƒ é–¢é€£" >> $REPORT_FILE
echo "### Sudoä½¿ç”¨å±¥æ­´" >> $REPORT_FILE
grep "sudo:" /var/log/auth.log | grep "$(date +%b' '%d)" >> $REPORT_FILE

echo "### ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œçŸ¥" >> $REPORT_FILE
aureport --file --start today --end today >> $REPORT_FILE

# 4. ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
FAILED_LOGINS=$(grep "Failed password" /var/log/auth.log | grep "$(date +%b' '%d)" | wc -l)
if [ $FAILED_LOGINS -gt 100 ]; then
    echo "WARNING: High number of failed logins: $FAILED_LOGINS" >> $REPORT_FILE
    mail -s "Security Alert: High Failed Logins" security@example.com < $REPORT_FILE
fi

echo "æ—¥æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†: $(date)" >> /var/log/security/security_ops.log
```

#### 3.1.2 è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆæ¯æ—¥ 2:00ï¼‰

```bash
#!/bin/bash
# daily_vulnerability_scan.sh

SCAN_DATE=$(date +%Y%m%d)
SCAN_TARGETS="localhost 192.168.1.100 192.168.1.101"
REPORT_DIR="/var/log/security/vulns"

mkdir -p $REPORT_DIR

for target in $SCAN_TARGETS; do
    echo "$(date): Scanning $target"
    
    # Nmapè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    nmap --script vuln -oN $REPORT_DIR/nmap_${target}_${SCAN_DATE}.txt $target
    
    # OpenVAS ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰
    if command -v omp &> /dev/null; then
        omp -u admin -w password --xml="<create_task>
            <name>Daily Scan $target</name>
            <config id=\"74db13d6-7489-11df-a3ec-002264764cea\"/>
            <target id=\"$target\"/>
        </create_task>"
    fi
    
    # çµæœåˆ†æ
    CRITICAL_VULNS=$(grep -c "Critical" $REPORT_DIR/nmap_${target}_${SCAN_DATE}.txt || echo 0)
    if [ $CRITICAL_VULNS -gt 0 ]; then
        echo "CRITICAL: $CRITICAL_VULNS critical vulnerabilities found on $target"
        mail -s "Critical Vulnerabilities Found" security@example.com \
            -a $REPORT_DIR/nmap_${target}_${SCAN_DATE}.txt
    fi
done

echo "$(date): Daily vulnerability scan completed" >> /var/log/security/security_ops.log
```

### 3.2 é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä½œæ¥­

#### 3.2.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ç¢ºèªï¼ˆæ¯é€±æ—¥æ›œæ—¥ï¼‰

```bash
#!/bin/bash
# weekly_patch_check.sh

echo "=== é€±æ¬¡ãƒ‘ãƒƒãƒç¢ºèª $(date) ==="

# 1. OS ãƒ‘ãƒƒãƒç¢ºèª
echo "## OS ãƒ‘ãƒƒãƒçŠ¶æ³"
if command -v apt &> /dev/null; then
    apt list --upgradable | grep -i security
elif command -v yum &> /dev/null; then
    yum check-update --security
fi

# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒãƒç¢ºèª
echo "## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒãƒçŠ¶æ³"

# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸æ›´æ–°ç¢ºèª
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" | grep -v "CREATED"

# æ‰‹å‹•æ›´æ–°ãŒå¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¢ºèª
echo "## æ‰‹å‹•ç¢ºèªãŒå¿…è¦ãªé …ç›®"
echo "- PostgreSQL: $(psql --version)"
echo "- Nginx: $(nginx -v 2>&1)"
echo "- OpenSSL: $(openssl version)"

# 3. CVE ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
echo "## é–¢é€£CVEç¢ºèª"
# ä½¿ç”¨ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®æ—¢çŸ¥è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
curl -s "https://cve.circl.lu/api/search/postgresql" | jq '.[]' | head -5

echo "$(date): Weekly patch check completed" >> /var/log/security/security_ops.log
```

#### 3.2.2 ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç›£æŸ»ï¼ˆæ¯é€±é‡‘æ›œæ—¥ï¼‰

```bash
#!/bin/bash
# weekly_access_audit.sh

AUDIT_DATE=$(date +%Y%m%d)
AUDIT_REPORT="/var/log/security/access_audit_$AUDIT_DATE.txt"

echo "=== ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç›£æŸ» $(date) ===" > $AUDIT_REPORT

# 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
echo "## ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§" >> $AUDIT_REPORT
awk -F: '$3 >= 1000 {print $1, $3, $5, $6, $7}' /etc/passwd >> $AUDIT_REPORT

# 2. sudo æ¨©é™ç¢ºèª
echo "## sudo æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼" >> $AUDIT_REPORT
grep -E '^%|^[^#]' /etc/sudoers /etc/sudoers.d/* >> $AUDIT_REPORT

# 3. SSH ã‚­ãƒ¼ç¢ºèª
echo "## SSH å…¬é–‹éµ" >> $AUDIT_REPORT
for user in $(awk -F: '$3 >= 1000 {print $1}' /etc/passwd); do
    if [ -f "/home/$user/.ssh/authorized_keys" ]; then
        echo "User: $user" >> $AUDIT_REPORT
        cat "/home/$user/.ssh/authorized_keys" >> $AUDIT_REPORT
    fi
done

# 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
echo "## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼" >> $AUDIT_REPORT
psql -c "SELECT usename, usesuper, usecreatedb FROM pg_user;" >> $AUDIT_REPORT

# 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™ç¢ºèª
echo "## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™" >> $AUDIT_REPORT
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ¨©é™ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
curl -s -H "Authorization: Bearer $ADMIN_TOKEN" \
    http://localhost:8080/admin/users | jq '.[]' >> $AUDIT_REPORT

echo "$(date): Weekly access audit completed" >> /var/log/security/security_ops.log
```

### 3.3 æœˆæ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä½œæ¥­

#### 3.3.1 åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡ï¼ˆæ¯æœˆç¬¬1åœŸæ›œæ—¥ï¼‰

```bash
#!/bin/bash
# monthly_security_assessment.sh

ASSESSMENT_DATE=$(date +%Y%m)
REPORT_DIR="/var/log/security/monthly/$ASSESSMENT_DATE"

mkdir -p $REPORT_DIR

echo "=== æœˆæ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡ $(date) ==="

# 1. ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
echo "## ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
python3 /opt/security/pentest.py --target localhost --output $REPORT_DIR/pentest.json

# 2. è¨­å®šç›£æŸ»
echo "## è¨­å®šç›£æŸ»"
# CIS Benchmark ãƒã‚§ãƒƒã‚¯
if command -v lynis &> /dev/null; then
    lynis audit system --report-file $REPORT_DIR/lynis_report.dat
fi

# 3. ãƒ­ã‚°åˆ†æ
echo "## æœˆæ¬¡ãƒ­ã‚°åˆ†æ"
# éå»1ãƒ¶æœˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé›†è¨ˆ
python3 /opt/security/log_analyzer.py --period 30 --output $REPORT_DIR/log_analysis.json

# 4. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo "## ç·åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
python3 /opt/security/report_generator.py \
    --pentest $REPORT_DIR/pentest.json \
    --lynis $REPORT_DIR/lynis_report.dat \
    --logs $REPORT_DIR/log_analysis.json \
    --output $REPORT_DIR/monthly_security_report.pdf

# 5. çµæœé€šçŸ¥
mail -s "Monthly Security Assessment Report" -a $REPORT_DIR/monthly_security_report.pdf \
    security@example.com ciso@example.com

echo "$(date): Monthly security assessment completed" >> /var/log/security/security_ops.log
```

## 4. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †

### 4.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡

#### 4.1.1 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡åŸºæº–

| ãƒ¬ãƒ™ãƒ« | å®šç¾© | ä¾‹ | å¯¾å¿œæ™‚é–“ |
|---|---|---|---|
| **Critical** | é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ | ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã€ã‚·ã‚¹ãƒ†ãƒ ä¹—ã£å–ã‚Š | 15åˆ†ä»¥å†… |
| **High** | é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹è±¡ | ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“ã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ | 1æ™‚é–“ä»¥å†… |
| **Medium** | è»½å¾®ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹è±¡ | è„†å¼±æ€§ç™ºè¦‹ã€è¨­å®šä¸å‚™ | 4æ™‚é–“ä»¥å†… |
| **Low** | æƒ…å ±æä¾›ãƒ¬ãƒ™ãƒ« | ç–‘ã‚ã—ã„æ´»å‹•ã€è­¦å‘Š | 24æ™‚é–“ä»¥å†… |

### 4.2 åˆæœŸå¯¾å¿œæ‰‹é †

#### 4.2.1 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¤œçŸ¥æ™‚å¯¾å¿œ

```bash
#!/bin/bash
# incident_response_initial.sh

INCIDENT_ID="$1"
INCIDENT_TYPE="$2"
SEVERITY="$3"

if [ -z "$INCIDENT_ID" ] || [ -z "$INCIDENT_TYPE" ] || [ -z "$SEVERITY" ]; then
    echo "Usage: $0 <incident_id> <incident_type> <severity>"
    exit 1
fi

INCIDENT_DIR="/var/log/security/incidents/$INCIDENT_ID"
mkdir -p $INCIDENT_DIR

echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆæœŸå¯¾å¿œ ===" | tee $INCIDENT_DIR/response.log
echo "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆID: $INCIDENT_ID" | tee -a $INCIDENT_DIR/response.log
echo "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç¨®åˆ¥: $INCIDENT_TYPE" | tee -a $INCIDENT_DIR/response.log
echo "é‡è¦åº¦: $SEVERITY" | tee -a $INCIDENT_DIR/response.log
echo "æ¤œçŸ¥æ™‚åˆ»: $(date)" | tee -a $INCIDENT_DIR/response.log

# 1. è¨¼è·¡ä¿å…¨
echo "$(date): è¨¼è·¡ä¿å…¨é–‹å§‹" | tee -a $INCIDENT_DIR/response.log

# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
ps aux > $INCIDENT_DIR/processes.txt
netstat -tulpn > $INCIDENT_DIR/network.txt
lsof > $INCIDENT_DIR/openfiles.txt
df -h > $INCIDENT_DIR/disk.txt
free -h > $INCIDENT_DIR/memory.txt

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
cp /var/log/auth.log $INCIDENT_DIR/
cp /var/log/nginx/access.log $INCIDENT_DIR/
cp /var/log/nginx/error.log $INCIDENT_DIR/
cp /var/log/application/*.log $INCIDENT_DIR/

# 2. å½±éŸ¿ç¯„å›²ç‰¹å®š
echo "$(date): å½±éŸ¿ç¯„å›²ç‰¹å®šé–‹å§‹" | tee -a $INCIDENT_DIR/response.log

case $INCIDENT_TYPE in
    "malware")
        # ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“å¯¾å¿œ
        clamav-daemon --infected-files=$INCIDENT_DIR/infected_files.txt
        ;;
    "unauthorized_access")
        # ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œ
        last -n 50 > $INCIDENT_DIR/login_history.txt
        w > $INCIDENT_DIR/current_users.txt
        ;;
    "data_breach")
        # ãƒ‡ãƒ¼ã‚¿æ¼æ´©å¯¾å¿œ
        audit_log_extract.sh > $INCIDENT_DIR/audit_extract.txt
        ;;
esac

# 3. ç·Šæ€¥é€£çµ¡
echo "$(date): ç·Šæ€¥é€£çµ¡å®Ÿæ–½" | tee -a $INCIDENT_DIR/response.log

if [ "$SEVERITY" = "Critical" ] || [ "$SEVERITY" = "High" ]; then
    # ç·Šæ€¥é€£çµ¡å…ˆã¸ã®é€šçŸ¥
    mail -s "SECURITY INCIDENT [$SEVERITY] $INCIDENT_TYPE" security@example.com << EOF
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆID: $INCIDENT_ID
ç¨®åˆ¥: $INCIDENT_TYPE
é‡è¦åº¦: $SEVERITY
æ¤œçŸ¥æ™‚åˆ»: $(date)

è©³ç´°ã¯ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š
$INCIDENT_DIR

åˆæœŸå¯¾å¿œè€…: $(whoami)
EOF

    # Slacké€šçŸ¥
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"ğŸš¨ SECURITY INCIDENT [$SEVERITY] $INCIDENT_TYPE - ID: $INCIDENT_ID\"}" \
        $SLACK_WEBHOOK_URL
fi

echo "$(date): åˆæœŸå¯¾å¿œå®Œäº†" | tee -a $INCIDENT_DIR/response.log
```

### 4.3 å°ã˜è¾¼ã‚å¯¾å¿œ

#### 4.3.1 æ‚ªæ„ã‚ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹é®æ–­

```bash
#!/bin/bash
# block_malicious_ip.sh

MALICIOUS_IP="$1"
REASON="$2"

if [ -z "$MALICIOUS_IP" ]; then
    echo "Usage: $0 <ip_address> [reason]"
    exit 1
fi

echo "$(date): Blocking malicious IP: $MALICIOUS_IP"

# 1. iptables ã«ã‚ˆã‚‹å³åº§ã®é®æ–­
iptables -I INPUT 1 -s $MALICIOUS_IP -j DROP
iptables -I OUTPUT 1 -d $MALICIOUS_IP -j DROP

# 2. fail2ban ã¸ã®è¿½åŠ 
fail2ban-client set nginx-http-auth banip $MALICIOUS_IP

# 3. WAF ã§ã®é®æ–­è¨­å®š
# ModSecurityè¨­å®šæ›´æ–°
echo "SecRule REMOTE_ADDR \"@ipMatch $MALICIOUS_IP\" \"id:9001,phase:1,block,msg:'Malicious IP blocked'\"" \
    >> /etc/nginx/modsecurity/custom_rules.conf

# 4. ãƒ­ã‚°è¨˜éŒ²
echo "$(date): IP $MALICIOUS_IP blocked. Reason: $REASON" >> /var/log/security/blocked_ips.log

# 5. é€šçŸ¥
mail -s "Malicious IP Blocked" security@example.com << EOF
æ‚ªæ„ã‚ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é®æ–­ã—ã¾ã—ãŸã€‚

IP Address: $MALICIOUS_IP
Reason: $REASON
Blocked Time: $(date)
Action: iptables + fail2ban + WAF

è©³ç´°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
EOF

echo "IP address $MALICIOUS_IP has been blocked successfully"
```

#### 4.3.2 æ„ŸæŸ“ã‚·ã‚¹ãƒ†ãƒ éš”é›¢

```bash
#!/bin/bash
# isolate_infected_system.sh

INFECTED_HOST="$1"
INCIDENT_ID="$2"

if [ -z "$INFECTED_HOST" ]; then
    echo "Usage: $0 <infected_host> [incident_id]"
    exit 1
fi

echo "$(date): Isolating infected system: $INFECTED_HOST"

# 1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éš”é›¢
if [ "$INFECTED_HOST" = "localhost" ]; then
    # ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å ´åˆ
    echo "WARNING: Isolating localhost - this will disconnect all network access"
    
    # ç·Šæ€¥éš”é›¢ãƒ¢ãƒ¼ãƒ‰
    iptables -P INPUT DROP
    iptables -P OUTPUT DROP
    iptables -P FORWARD DROP
    
    # ç®¡ç†ç”¨SSHã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A OUTPUT -o lo -j ACCEPT
    iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT
    iptables -A OUTPUT -p tcp --sport 22 -d 192.168.1.0/24 -j ACCEPT
    
else
    # ãƒªãƒ¢ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å ´åˆ
    ssh $INFECTED_HOST "
        iptables -P INPUT DROP
        iptables -P OUTPUT DROP
        iptables -P FORWARD DROP
        iptables -A INPUT -i lo -j ACCEPT
        iptables -A OUTPUT -o lo -j ACCEPT
    "
fi

# 2. ç–‘ã‚ã—ã„ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢
SUSPICIOUS_PROCESSES="cryptominer malware backdoor"
for process in $SUSPICIOUS_PROCESSES; do
    if [ "$INFECTED_HOST" = "localhost" ]; then
        pkill -f $process
    else
        ssh $INFECTED_HOST "pkill -f $process"
    fi
done

# 3. è¨¼è·¡ä¿å…¨
EVIDENCE_DIR="/var/log/security/incidents/$INCIDENT_ID/evidence"
mkdir -p $EVIDENCE_DIR

if [ "$INFECTED_HOST" = "localhost" ]; then
    # ãƒ¡ãƒ¢ãƒªãƒ€ãƒ³ãƒ—å–å¾—
    dd if=/dev/mem of=$EVIDENCE_DIR/memory_dump.img bs=1M
    
    # ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ä¿å­˜
    ps auxf > $EVIDENCE_DIR/process_tree.txt
    lsof > $EVIDENCE_DIR/open_files.txt
    
else
    # ãƒªãƒ¢ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®è¨¼è·¡åé›†
    ssh $INFECTED_HOST "ps auxf" > $EVIDENCE_DIR/remote_processes.txt
    ssh $INFECTED_HOST "lsof" > $EVIDENCE_DIR/remote_openfiles.txt
fi

# 4. é€šçŸ¥
mail -s "System Isolated - $INFECTED_HOST" security@example.com << EOF
æ„ŸæŸ“ã‚·ã‚¹ãƒ†ãƒ ã‚’éš”é›¢ã—ã¾ã—ãŸã€‚

Host: $INFECTED_HOST
Incident ID: $INCIDENT_ID
Isolation Time: $(date)

å®Ÿæ–½ã•ã‚ŒãŸéš”é›¢æªç½®:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹é®æ–­
- ç–‘ã‚ã—ã„ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢
- è¨¼è·¡ä¿å…¨å®Ÿæ–½

è©³ç´°èª¿æŸ»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
EOF

echo "$(date): System $INFECTED_HOST isolated successfully" >> /var/log/security/isolation.log
```

## 5. ãƒ•ã‚©ãƒ¬ãƒ³ã‚¸ãƒƒã‚¯èª¿æŸ»

### 5.1 ãƒ­ã‚°åˆ†æ

#### 5.1.1 è‡ªå‹•ãƒ­ã‚°åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
#!/usr/bin/env python3
# forensic_log_analysis.py

import json
import re
import sys
from datetime import datetime, timedelta
from collections import defaultdict, Counter
import geoip2.database

class ForensicAnalyzer:
    def __init__(self):
        self.suspicious_patterns = [
            r'(?i)(union|select|insert|update|delete|drop)\s+.*\s+(from|into|table)',  # SQL Injection
            r'(?i)<script[^>]*>.*</script>',  # XSS
            r'(?i)(\.\./){2,}',  # Directory Traversal
            r'(?i)(cmd|exec|system|shell_exec|passthru)',  # Command Injection
            r'(?i)/etc/passwd',  # System File Access
        ]
        
        self.geoip_reader = None
        try:
            self.geoip_reader = geoip2.database.Reader('/usr/share/GeoIP/GeoLite2-Country.mmdb')
        except:
            print("Warning: GeoIP database not found")
    
    def analyze_web_logs(self, log_file):
        """Web ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®åˆ†æ"""
        results = {
            'suspicious_requests': [],
            'top_ips': Counter(),
            'error_patterns': Counter(),
            'geographic_distribution': Counter()
        }
        
        with open(log_file, 'r') as f:
            for line in f:
                # Nginxãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè§£æ
                match = re.match(r'(\S+) - - \[([^\]]+)\] "(\S+) ([^"]*)" (\d+) (\d+) "([^"]*)" "([^"]*)"', line)
                if not match:
                    continue
                    
                ip, timestamp, method, uri, status, size, referer, user_agent = match.groups()
                
                # IPé›†è¨ˆ
                results['top_ips'][ip] += 1
                
                # åœ°ç†çš„åˆ†å¸ƒï¼ˆGeoIPåˆ©ç”¨ï¼‰
                if self.geoip_reader:
                    try:
                        response = self.geoip_reader.country(ip)
                        results['geographic_distribution'][response.country.iso_code] += 1
                    except:
                        results['geographic_distribution']['Unknown'] += 1
                
                # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ†æ
                if int(status) >= 400:
                    results['error_patterns'][f"{status} {uri}"] += 1
                
                # ç–‘ã‚ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
                for pattern in self.suspicious_patterns:
                    if re.search(pattern, uri) or re.search(pattern, user_agent):
                        results['suspicious_requests'].append({
                            'ip': ip,
                            'timestamp': timestamp,
                            'method': method,
                            'uri': uri,
                            'status': status,
                            'user_agent': user_agent,
                            'pattern': pattern
                        })
        
        return results
    
    def analyze_auth_logs(self, log_file):
        """èªè¨¼ãƒ­ã‚°ã®åˆ†æ"""
        results = {
            'failed_logins': defaultdict(list),
            'successful_logins': defaultdict(list),
            'brute_force_attempts': [],
            'unusual_login_times': []
        }
        
        with open(log_file, 'r') as f:
            for line in f:
                if 'Failed password' in line:
                    # å¤±æ•—ãƒ­ã‚°ã‚¤ãƒ³è§£æ
                    match = re.search(r'Failed password for (\w+) from (\S+)', line)
                    if match:
                        user, ip = match.groups()
                        timestamp = self.extract_timestamp(line)
                        results['failed_logins'][ip].append({
                            'user': user,
                            'timestamp': timestamp
                        })
                
                elif 'Accepted password' in line:
                    # æˆåŠŸãƒ­ã‚°ã‚¤ãƒ³è§£æ
                    match = re.search(r'Accepted password for (\w+) from (\S+)', line)
                    if match:
                        user, ip = match.groups()
                        timestamp = self.extract_timestamp(line)
                        results['successful_logins'][ip].append({
                            'user': user,
                            'timestamp': timestamp
                        })
                        
                        # ç•°å¸¸ãƒ­ã‚°ã‚¤ãƒ³æ™‚é–“æ¤œçŸ¥ï¼ˆå–¶æ¥­æ™‚é–“å¤–ï¼‰
                        if timestamp.hour < 9 or timestamp.hour > 18:
                            results['unusual_login_times'].append({
                                'user': user,
                                'ip': ip,
                                'timestamp': timestamp
                            })
        
        # ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒæ¤œçŸ¥
        for ip, attempts in results['failed_logins'].items():
            if len(attempts) > 10:  # 10å›ä»¥ä¸Šã®å¤±æ•—
                results['brute_force_attempts'].append({
                    'ip': ip,
                    'attempts': len(attempts),
                    'users_targeted': list(set([a['user'] for a in attempts]))
                })
        
        return results
    
    def extract_timestamp(self, log_line):
        """ãƒ­ã‚°ã‹ã‚‰æ—¥æ™‚ã‚’æŠ½å‡º"""
        # ç°¡æ˜“å®Ÿè£…ï¼ˆå®Ÿéš›ã¯ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¿œã˜ã¦èª¿æ•´ï¼‰
        try:
            match = re.search(r'(\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})', log_line)
            if match:
                time_str = match.group(1)
                # å¹´ã‚’è¿½åŠ ã—ã¦è§£æ
                time_str = f"2024 {time_str}"
                return datetime.strptime(time_str, "%Y %b %d %H:%M:%S")
        except:
            pass
        return datetime.now()
    
    def generate_report(self, analysis_results, output_file):
        """åˆ†æçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""
        report = {
            'analysis_time': datetime.now().isoformat(),
            'summary': {
                'total_suspicious_requests': len(analysis_results.get('suspicious_requests', [])),
                'total_brute_force_attempts': len(analysis_results.get('brute_force_attempts', [])),
                'total_unusual_logins': len(analysis_results.get('unusual_login_times', []))
            },
            'details': analysis_results
        }
        
        with open(output_file, 'w') as f:
            json.dump(report, f, indent=2, default=str)
        
        print(f"Forensic analysis report saved to {output_file}")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python3 forensic_log_analysis.py <log_type> <log_file> [output_file]")
        print("Log types: web, auth")
        sys.exit(1)
    
    log_type = sys.argv[1]
    log_file = sys.argv[2]
    output_file = sys.argv[3] if len(sys.argv) > 3 else f"forensic_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    
    analyzer = ForensicAnalyzer()
    
    if log_type == "web":
        results = analyzer.analyze_web_logs(log_file)
    elif log_type == "auth":
        results = analyzer.analyze_auth_logs(log_file)
    else:
        print("Unsupported log type")
        sys.exit(1)
    
    analyzer.generate_report(results, output_file)
```

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²ãƒ»è¨“ç·´

### 6.1 å®šæœŸè¨“ç·´

#### 6.1.1 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨“ç·´ï¼ˆå››åŠæœŸï¼‰

```bash
#!/bin/bash
# incident_response_drill.sh

DRILL_DATE=$(date +%Y%m%d)
DRILL_TYPE="$1"  # malware, breach, ddos

echo "=== ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨“ç·´ $(date) ==="
echo "è¨“ç·´ç¨®åˆ¥: $DRILL_TYPE"

case $DRILL_TYPE in
    "malware")
        echo "## ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“å¯¾å¿œè¨“ç·´"
        echo "ã‚·ãƒŠãƒªã‚ª: Webã‚µãƒ¼ãƒãƒ¼ã§ãƒãƒ«ã‚¦ã‚§ã‚¢æ¤œçŸ¥"
        
        # æ¨¡æ“¬ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
        echo "ALERT: Malware detected on web-server-01" | \
            mail -s "DRILL: Malware Detection" security@example.com
        
        # å¯¾å¿œæ‰‹é †ç¢ºèª
        echo "å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:"
        echo "[ ] ã‚·ã‚¹ãƒ†ãƒ éš”é›¢å®Ÿæ–½"
        echo "[ ] è¨¼è·¡ä¿å…¨å®Ÿæ–½"  
        echo "[ ] ãƒãƒ«ã‚¦ã‚§ã‚¢ç‰¹å®šãƒ»é™¤å»"
        echo "[ ] è¢«å®³ç¯„å›²èª¿æŸ»"
        echo "[ ] å¾©æ—§æ‰‹é †å®Ÿæ–½"
        ;;
        
    "breach")
        echo "## ãƒ‡ãƒ¼ã‚¿æ¼æ´©å¯¾å¿œè¨“ç·´"
        echo "ã‚·ãƒŠãƒªã‚ª: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚‹å€‹äººæƒ…å ±æ¼æ´©"
        
        # æ¨¡æ“¬ãƒ­ã‚°ç”Ÿæˆ
        echo "$(date): Unauthorized access to customer database detected" >> /tmp/drill_alert.log
        
        echo "å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:"
        echo "[ ] ã‚¢ã‚¯ã‚»ã‚¹é®æ–­å®Ÿæ–½"
        echo "[ ] æ¼æ´©ç¯„å›²ç‰¹å®š"
        echo "[ ] é–¢ä¿‚æ©Ÿé–¢ã¸ã®å ±å‘Š"
        echo "[ ] é¡§å®¢ã¸ã®é€šçŸ¥æº–å‚™"
        echo "[ ] å†ç™ºé˜²æ­¢ç­–ç­–å®š"
        ;;
        
    "ddos")
        echo "## DDoSæ”»æ’ƒå¯¾å¿œè¨“ç·´"
        echo "ã‚·ãƒŠãƒªã‚ª: Webã‚µã‚¤ãƒˆã¸ã®å¤§è¦æ¨¡DDoSæ”»æ’ƒ"
        
        echo "å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:"
        echo "[ ] æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ"
        echo "[ ] ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶é™å®Ÿæ–½"
        echo "[ ] CDNãƒ»WAFè¨­å®šèª¿æ•´"
        echo "[ ] ä¸ŠæµISPã¨ã®é€£æº"
        echo "[ ] ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šæ€§ç¢ºä¿"
        ;;
esac

echo ""
echo "è¨“ç·´å®Œäº†å¾Œã¯ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„:"
echo "1. å¯¾å¿œæ™‚é–“ã®è¨˜éŒ²"
echo "2. èª²é¡Œãƒ»æ”¹å–„ç‚¹ã®æ´—ã„å‡ºã—"
echo "3. æ‰‹é †æ›¸ã®æ›´æ–°"
echo "4. è¨“ç·´ãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ"

echo "$(date): Incident response drill ($DRILL_TYPE) completed" >> /var/log/security/training.log
```

### 6.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜å‘ä¸Š

#### 6.2.1 ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è¨“ç·´

```python
#!/usr/bin/env python3
# phishing_simulation.py

import smtplib
import random
from email.mime.text import MimeText
from email.mime.multipart import MimeMultipart
from datetime import datetime

class PhishingSimulation:
    def __init__(self):
        self.smtp_server = "localhost"
        self.smtp_port = 587
        self.sender_email = "security-training@example.com"
        
        self.templates = [
            {
                'subject': 'ã€ç·Šæ€¥ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã®ãŠçŸ¥ã‚‰ã›',
                'body': '''
ãŠç–²ã‚Œæ§˜ã§ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚
ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‚ˆã‚Šå¤‰æ›´ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒªãƒ³ã‚¯]
http://fake-login.training.example.com/reset

â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è¨“ç·´ç”¨ã§ã™ã€‚å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã—ãªã„ã§ãã ã•ã„ã€‚
''',
                'risk_level': 'medium'
            },
            {
                'subject': 'ã€é‡è¦ã€‘ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›',
                'body': '''
ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ã™ã€‚

ç·Šæ€¥ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚ã€ä¸€æ™‚çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
ä¸‹è¨˜ã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚

[ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹]
http://fake-portal.training.example.com/login

â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è¨“ç·´ç”¨ã§ã™ã€‚å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã—ãªã„ã§ãã ã•ã„ã€‚
''',
                'risk_level': 'high'
            }
        ]
    
    def send_simulation_email(self, target_emails):
        """ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è¨“ç·´ãƒ¡ãƒ¼ãƒ«é€ä¿¡"""
        template = random.choice(self.templates)
        
        for email in target_emails:
            msg = MimeMultipart()
            msg['From'] = self.sender_email
            msg['To'] = email
            msg['Subject'] = template['subject']
            
            # å€‹äººåŒ–
            body = template['body'].replace('[USER]', email.split('@')[0])
            msg.attach(MimeText(body, 'plain'))
            
            try:
                server = smtplib.SMTP(self.smtp_server, self.smtp_port)
                server.send_message(msg)
                server.quit()
                
                # ãƒ­ã‚°è¨˜éŒ²
                with open('/var/log/security/phishing_simulation.log', 'a') as f:
                    f.write(f"{datetime.now()}: Simulation email sent to {email}, template: {template['risk_level']}\n")
                    
            except Exception as e:
                print(f"Failed to send email to {email}: {e}")
    
    def track_clicks(self, log_file):
        """ã‚¯ãƒªãƒƒã‚¯ç‡è¿½è·¡"""
        clicked_users = set()
        
        # Webã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚µã‚¤ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œå‡º
        with open(log_file, 'r') as f:
            for line in f:
                if 'training.example.com' in line:
                    # IPã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®šï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
                    ip_match = re.search(r'(\d+\.\d+\.\d+\.\d+)', line)
                    if ip_match:
                        clicked_users.add(ip_match.group(1))
        
        return len(clicked_users)

if __name__ == "__main__":
    simulator = PhishingSimulation()
    
    # å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
    target_users = [
        "user1@example.com",
        "user2@example.com", 
        "user3@example.com"
    ]
    
    print("ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è¨“ç·´ã‚’é–‹å§‹ã—ã¾ã™...")
    simulator.send_simulation_email(target_users)
    print("è¨“ç·´ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚")
```

---

**æ³¨æ„**: ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨æ‰‹é †æ›¸ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¶­æŒã®ãŸã‚ã®é‡è¦ãªæ‰‹é †ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®é‹ç”¨ã§ã¯æœ€æ–°ã®è„…å¨æƒ…å ±ã«åŸºã¥ã„ã¦ç¶™ç¶šçš„ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚