# セキュリティ設計書

**タイトル**: セキュリティ設計書  
**バージョン**: 1.0.0  
**最終更新日**: YYYY-MM-DD  
**作成者**: [作成者名]  
**レビュアー**: [レビュアー名]  
**関連ドキュメント**: system-architecture.md, non-functional-requirements.md  
**ステータス**: draft  

---

## 1. 概要

### 1.1 目的
本文書は、システムのセキュリティ要件を満たすための包括的なセキュリティ設計を定義し、脅威からシステムとデータを保護することを目的とする。

### 1.2 適用範囲
本セキュリティ設計は、システム全体に適用される：
- アプリケーションセキュリティ
- ネットワークセキュリティ
- データセキュリティ
- インフラストラクチャセキュリティ
- 運用セキュリティ

### 1.3 セキュリティ設計原則
- **多層防御**: 複数のセキュリティ層による包括的な保護
- **最小権限**: 必要最小限の権限のみ付与
- **デフォルト拒否**: 明示的に許可されたもの以外は拒否
- **深度防御**: 各層での独立したセキュリティ対策
- **継続的監視**: セキュリティ状況の継続的な監視・評価

## 2. 脅威分析

### 2.1 脅威モデリング

#### 2.1.1 STRIDE分析
| 脅威カテゴリ | 説明 | 対象資産 | 対策 |
|---|---|---|---|
| **S**poofing | なりすまし | ユーザーID、システムID | 多要素認証、デジタル証明書 |
| **T**ampering | 改ざん | データ、設定ファイル | デジタル署名、整合性チェック |
| **R**epudiation | 否認 | 操作ログ、取引記録 | デジタル署名、監査ログ |
| **I**nformation Disclosure | 情報漏えい | 個人情報、機密データ | 暗号化、アクセス制御 |
| **D**enial of Service | サービス拒否 | Webサービス、DB | 負荷分散、レート制限 |
| **E**levation of Privilege | 権限昇格 | 管理者権限 | 最小権限、権限管理 |

#### 2.1.2 攻撃ベクター分析
```
┌─────────────────────────────────────────────────────────┐
│                  外部攻撃者                              │
└─────────────────┬───────────────────────────────────────┘
                  │
    ┌─────────────▼─────────────┐
    │       インターネット        │
    └─────────────┬─────────────┘
                  │
    ┌─────────────▼─────────────┐
    │         WAF/FW           │ ← DDoS、SQLインジェクション
    └─────────────┬─────────────┘
                  │
    ┌─────────────▼─────────────┐
    │       Webアプリ           │ ← XSS、CSRF、認証回避
    └─────────────┬─────────────┘
                  │
    ┌─────────────▼─────────────┐
    │      データベース          │ ← SQLインジェクション、権限昇格
    └───────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                  内部攻撃者                              │
└─────────────────┬───────────────────────────────────────┘
                  │
    ┌─────────────▼─────────────┐
    │       内部ネットワーク      │ ← 権限昇格、データ窃取
    └─────────────┬─────────────┘
                  │
    ┌─────────────▼─────────────┐
    │       業務システム         │ ← 不正アクセス、データ改ざん
    └───────────────────────────┘
```

### 2.2 リスク評価

#### 2.2.1 リスクマトリックス
| 脅威 | 発生確率 | 影響度 | リスクレベル | 対策優先度 |
|---|---|---|---|---|
| SQLインジェクション | 中 | 高 | 高 | 1 |
| XSS攻撃 | 高 | 中 | 高 | 1 |
| DDoS攻撃 | 中 | 中 | 中 | 2 |
| 内部不正 | 低 | 高 | 中 | 2 |
| フィッシング | 高 | 低 | 中 | 3 |
| 物理的侵入 | 低 | 中 | 低 | 3 |

## 3. 認証・認可設計

### 3.1 認証アーキテクチャ

#### 3.1.1 認証フロー
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │    │Auth Service │    │  User DB    │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Login Request  │                   │
       ├──────────────────►│                   │
       │                   │ 2. Validate       │
       │                   ├──────────────────►│
       │                   │ 3. User Info      │
       │                   │◄──────────────────┤
       │                   │ 4. Generate JWT   │
       │                   │                   │
       │ 5. JWT + Refresh  │                   │
       │◄──────────────────┤                   │
       │                   │                   │
       │ 6. API Request    │                   │
       ├──────────────────►│                   │
       │                   │ 7. Validate JWT   │
       │                   │                   │
       │ 8. Response       │                   │
       │◄──────────────────┤                   │
```

#### 3.1.2 JWT設計
```json
// JWTヘッダー
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-id-2024"
}

// JWTペイロード
{
  "iss": "https://auth.example.com",
  "sub": "user-123",
  "aud": "https://api.example.com",
  "exp": 1609459200,
  "iat": 1609455600,
  "jti": "jwt-id-unique",
  "user_id": 123,
  "username": "user@example.com",
  "roles": ["user", "manager"],
  "permissions": ["read:orders", "write:orders"],
  "department_id": 1
}
```

### 3.2 多要素認証（MFA）

#### 3.2.1 MFA方式
- **SMS認証**: 携帯電話番号への認証コード送信
- **TOTP**: Time-based One-Time Password（Google Authenticator等）
- **WebAuthn**: FIDO2/WebAuthn準拠の生体認証・ハードウェアキー
- **プッシュ通知**: モバイルアプリへのプッシュ通知認証

#### 3.2.2 MFAフロー
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │    │Auth Service │    │ MFA Provider│
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Login + Pass   │                   │
       ├──────────────────►│                   │
       │                   │ 2. Send MFA       │
       │                   ├──────────────────►│
       │ 3. MFA Challenge  │                   │
       │◄──────────────────┤                   │
       │                   │                   │
       │ 4. MFA Response   │                   │
       ├──────────────────►│                   │
       │                   │ 5. Verify MFA     │
       │                   ├──────────────────►│
       │                   │ 6. MFA Result     │
       │                   │◄──────────────────┤
       │ 7. Access Token   │                   │
       │◄──────────────────┤                   │
```

### 3.3 認可設計（RBAC）

#### 3.3.1 RBAC モデル
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    Users    │    │    Roles    │    │Permissions  │
│             │    │             │    │             │
│ ・admin     │────┤ ・admin     │────┤ ・read:all  │
│ ・manager   │    │ ・manager   │    │ ・write:all │
│ ・user      │    │ ・user      │    │ ・delete:own│
│ ・guest     │    │ ・guest     │    │ ・execute   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
               ┌─────────────▼─────────────┐
               │        Resources          │
               │                           │
               │ ・users     ・reports     │
               │ ・orders    ・settings    │
               │ ・products  ・logs        │
               └───────────────────────────┘
```

#### 3.3.2 権限マトリックス
| ロール | ユーザー管理 | 注文管理 | 商品管理 | レポート | システム設定 |
|---|---|---|---|---|---|
| システム管理者 | CRUD | CRUD | CRUD | R | CRUD |
| 管理者 | CRU | CRUD | CRUD | R | R |
| マネージャー | R | CRUD | CRU | R | - |
| 一般ユーザー | R(自分のみ) | CR | R | - | - |
| ゲスト | - | R | R | - | - |

## 4. データセキュリティ

### 4.1 データ分類

#### 4.1.1 データ分類基準
| 分類 | 説明 | 例 | 保護レベル |
|---|---|---|---|
| **機密** | 漏えいにより重大な損害 | 個人情報、財務データ | 最高 |
| **重要** | 漏えいにより業務影響 | 顧客情報、契約情報 | 高 |
| **社内** | 社内限定情報 | 組織図、社内規定 | 中 |
| **公開** | 公開可能情報 | 製品カタログ | 低 |

#### 4.1.2 データライフサイクル
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   作成      │───►│    使用     │───►│    保管     │
│ ・分類設定   │    │ ・アクセス制御│    │ ・暗号化    │
│ ・暗号化    │    │ ・監査ログ   │    │ ・バックアップ│
└─────────────┘    └─────────────┘    └─────────────┘
                                             │
┌─────────────┐    ┌─────────────┐           │
│   廃棄      │◄───│    移動     │◄──────────┘
│ ・完全削除   │    │ ・暗号化転送 │
│ ・証明書    │    │ ・整合性確認 │
└─────────────┘    └─────────────┘
```

### 4.2 暗号化設計

#### 4.2.1 暗号化方式

**転送時暗号化**
- **プロトコル**: TLS 1.3
- **暗号スイート**: AES-256-GCM, ChaCha20-Poly1305
- **鍵交換**: ECDHE (P-256, P-384)
- **ハッシュ**: SHA-256, SHA-384

**保存時暗号化**
- **データベース**: AES-256 (透過的暗号化)
- **ファイル**: AES-256-CBC
- **フィールドレベル**: AES-256-GCM (機密フィールド)
- **バックアップ**: AES-256-CBC

#### 4.2.2 鍵管理
```
┌─────────────────────────────────────────────────────────┐
│                 Key Management System                   │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Master Key  │  │   DEK       │  │   Backup    │    │
│  │ (HSM)       │  │ (Database)  │  │   Keys      │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│Application  │  │  Database   │  │  Backup     │
│Encryption   │  │ Encryption  │  │ Encryption  │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 4.3 個人情報保護

#### 4.3.1 個人情報の特定と分類
| データ項目 | 分類 | 暗号化 | 仮名化 | アクセス制御 |
|---|---|---|---|---|
| 氏名 | 個人情報 | Yes | Yes | 制限 |
| メールアドレス | 個人情報 | Yes | Yes | 制限 |
| 電話番号 | 個人情報 | Yes | Yes | 制限 |
| 住所 | 個人情報 | Yes | Yes | 制限 |
| クレジットカード番号 | 要配慮個人情報 | Yes | No | 厳格制限 |
| 生年月日 | 個人情報 | Yes | Yes | 制限 |

#### 4.3.2 同意管理
```sql
-- 同意管理テーブル
CREATE TABLE consent_records (
    consent_id      SERIAL PRIMARY KEY,
    user_id         INTEGER NOT NULL,
    purpose         VARCHAR(100) NOT NULL,
    consent_given   BOOLEAN NOT NULL,
    consent_date    TIMESTAMP NOT NULL,
    withdrawal_date TIMESTAMP,
    legal_basis     VARCHAR(50) NOT NULL,
    data_retention  INTERVAL NOT NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 5. ネットワークセキュリティ

### 5.1 ネットワーク構成

#### 5.1.1 ネットワークセグメンテーション
```
                    Internet
                        │
                  ┌─────┴─────┐
                  │    WAF    │
                  │   (DMZ)   │
                  └─────┬─────┘
                        │
              ┌─────────┴─────────┐
              │    Firewall       │
              └─────────┬─────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
   ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
   │  Web    │    │  App    │    │   DB    │
   │ Tier    │    │ Tier    │    │  Tier   │
   │(Public) │    │(Private)│    │(Private)│
   └─────────┘    └─────────┘    └─────────┘
```

#### 5.1.2 ファイアウォールルール
| Source | Destination | Port | Protocol | Action | Purpose |
|---|---|---|---|---|---|
| Internet | DMZ | 80,443 | TCP | Allow | HTTP/HTTPS |
| DMZ | Web Tier | 80,443 | TCP | Allow | Web Traffic |
| Web Tier | App Tier | 8080 | TCP | Allow | App Traffic |
| App Tier | DB Tier | 5432 | TCP | Allow | Database |
| Any | Any | Any | Any | Deny | Default Deny |

### 5.2 侵入検知・防御

#### 5.2.1 IDS/IPS配置
```
Internet ──► [IPS] ──► Firewall ──► [IDS] ──► Internal Network
                                      │
                                      ▼
                               SIEM/SOC Center
```

#### 5.2.2 検知ルール
- **シグネチャベース**: 既知の攻撃パターン検知
- **アノマリベース**: 通常の通信パターンからの逸脱検知
- **ヒューリスティック**: 疑わしい動作の検知

## 6. アプリケーションセキュリティ

### 6.1 OWASP Top 10対策

#### 6.1.1 インジェクション対策
```java
// 悪い例：SQLインジェクションの脆弱性
String query = "SELECT * FROM users WHERE username = '" + username + "'";

// 良い例：プリペアードステートメント使用
String query = "SELECT * FROM users WHERE username = ?";
PreparedStatement ps = connection.prepareStatement(query);
ps.setString(1, username);
```

#### 6.1.2 XSS対策
```javascript
// 入力値のサニタイゼーション
function sanitizeInput(input) {
    return input
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}

// CSP（Content Security Policy）設定
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'
```

#### 6.1.3 CSRF対策
```html
<!-- CSRFトークンの実装 -->
<form method="POST" action="/update-profile">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- フォームフィールド -->
</form>
```

### 6.2 セキュアコーディング

#### 6.2.1 入力値検証
```java
// 入力値検証の実装
@Valid
public class UserCreateRequest {
    @NotBlank(message = "ユーザー名は必須です")
    @Size(min = 3, max = 50, message = "ユーザー名は3-50文字で入力してください")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ユーザー名は英数字とアンダースコアのみ使用可能です")
    private String username;
    
    @Email(message = "有効なメールアドレスを入力してください")
    @NotBlank(message = "メールアドレスは必須です")
    private String email;
    
    @NotBlank(message = "パスワードは必須です")
    @Size(min = 8, message = "パスワードは8文字以上で入力してください")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]", 
             message = "パスワードは大文字、小文字、数字、特殊文字を含む必要があります")
    private String password;
}
```

#### 6.2.2 セキュアな設定管理
```yaml
# セキュリティ設定
security:
  headers:
    content-security-policy: "default-src 'self'; script-src 'self'"
    x-frame-options: "DENY"
    x-content-type-options: "nosniff"
    x-xss-protection: "1; mode=block"
    strict-transport-security: "max-age=31536000; includeSubDomains"
  
  session:
    cookie:
      secure: true
      http-only: true
      same-site: "Strict"
    timeout: 3600
    
  password:
    min-length: 8
    require-special-chars: true
    require-numbers: true
    require-uppercase: true
    require-lowercase: true
    max-age: 90
```

## 7. 監視・ログ設計

### 7.1 セキュリティ監視

#### 7.1.1 監視項目
| カテゴリ | 監視項目 | 閾値 | アクション |
|---|---|---|---|
| 認証 | ログイン失敗回数 | 5回/5分 | アカウントロック |
| 認証 | 異常ログイン時間 | 営業時間外 | アラート通知 |
| アクセス | API呼び出し頻度 | 1000回/分 | レート制限 |
| アクセス | 異常なアクセスパターン | - | アラート通知 |
| データ | 大量データダウンロード | 10MB/分 | アラート通知 |
| システム | CPU使用率 | 90% | アラート通知 |

#### 7.1.2 SIEM連携
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│Application  │    │    SIEM     │    │    SOC      │
│    Logs     │───►│   System    │───►│   Center    │
└─────────────┘    └─────────────┘    └─────────────┘
┌─────────────┐           │
│ Network     │───────────┘
│    Logs     │
└─────────────┘
┌─────────────┐
│ Security    │───────────┐
│ Events      │           │
└─────────────┘           ▼
                   ┌─────────────┐
                   │   Alert     │
                   │ Management  │
                   └─────────────┘
```

### 7.2 監査ログ

#### 7.2.1 監査ログ要件
```json
{
  "timestamp": "2024-01-01T10:00:00Z",
  "event_id": "audit-123456",
  "event_type": "DATA_ACCESS",
  "user": {
    "id": 123,
    "username": "user@example.com",
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0..."
  },
  "resource": {
    "type": "USER",
    "id": 456,
    "action": "READ"
  },
  "result": "SUCCESS",
  "risk_score": 2,
  "session_id": "session-789",
  "correlation_id": "corr-abc123"
}
```

#### 7.2.2 ログ保持ポリシー
| ログタイプ | 保持期間 | 保存場所 | アクセス制御 |
|---|---|---|---|
| 認証ログ | 3年 | セキュアストレージ | 制限 |
| 操作ログ | 5年 | セキュアストレージ | 制限 |
| アクセスログ | 1年 | 標準ストレージ | 一般 |
| システムログ | 6ヶ月 | 標準ストレージ | 一般 |

## 8. インシデント対応

### 8.1 インシデント分類

#### 8.1.1 深刻度レベル
| レベル | 定義 | 対応時間 | エスカレーション |
|---|---|---|---|
| Critical | システム全停止、大規模漏えい | 15分 | 即座に経営陣 |
| High | 重要機能停止、限定的漏えい | 1時間 | 2時間後に管理職 |
| Medium | 一部機能停止、軽微な問題 | 4時間 | 翌営業日に報告 |
| Low | 軽微な問題、性能劣化 | 24時間 | 週次報告 |

#### 8.1.2 対応フロー
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   検知      │───►│   分析      │───►│   対応      │
│ ・自動検知   │    │ ・影響評価   │    │ ・隔離      │
│ ・手動報告   │    │ ・原因調査   │    │ ・修復      │
└─────────────┘    └─────────────┘    └─────────────┘
                                             │
┌─────────────┐    ┌─────────────┐           │
│   報告      │◄───│   復旧      │◄──────────┘
│ ・ステークホルダー│  │ ・サービス復旧│
│ ・監督機関   │    │ ・監視強化   │
└─────────────┘    └─────────────┘
```

### 8.2 事業継続計画

#### 8.2.1 復旧時間目標
| システム | RPO | RTO | 優先度 |
|---|---|---|---|
| 認証システム | 15分 | 30分 | 最高 |
| 業務システム | 1時間 | 2時間 | 高 |
| レポートシステム | 4時間 | 8時間 | 中 |
| 分析システム | 24時間 | 48時間 | 低 |

---

**注意**: このセキュリティ設計書は、システムの安全性を確保する重要な文書です。実装時は最新の脅威情報を参考に適切な対策を実施してください。