# システム方式設計書

**タイトル**: システム方式設計書  
**バージョン**: 1.0.0  
**最終更新日**: YYYY-MM-DD  
**作成者**: [作成者名]  
**レビュアー**: [レビュアー名]  
**関連ドキュメント**: system-architecture.md, functional-requirements.md  
**ステータス**: draft  

---

## 1. 概要

### 1.1 目的
本文書は、システム全体アーキテクチャに基づき、具体的なシステム方式を定義し、各構成要素の役割と相互関係を明確にすることを目的とする。

### 1.2 適用範囲
本方式設計は、[システム名]の全機能に適用される。

### 1.3 システム方式の基本方針
- **分散処理**: 負荷分散による性能向上
- **疎結合**: コンポーネント間の独立性確保
- **標準化**: 業界標準技術の採用
- **自動化**: 運用作業の自動化
- **監視**: システム状態の可視化

## 2. システム構成

### 2.1 物理構成

```
┌─────────────────── DMZ ──────────────────┐
│                                          │
│  ┌─────────────┐    ┌─────────────┐     │
│  │ Load        │    │   WAF       │     │
│  │ Balancer    │    │ (Web App    │     │  インターネット
│  │ (Nginx)     │    │ Firewall)   │     │      ↕
│  └─────────────┘    └─────────────┘     │
│         │                   │           │
└─────────┼───────────────────┼───────────┘
          │                   │
┌─────────┼─── Web層 ─────────┼───────────┐
│         ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐     │
│  │ Web Server  │    │ Web Server  │     │
│  │ #1 (Nginx)  │    │ #2 (Nginx)  │     │
│  └─────────────┘    └─────────────┘     │
│         │                   │           │
└─────────┼───────────────────┼───────────┘
          │                   │
┌─────────┼── App層 ──────────┼───────────┐
│         ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐     │
│  │   App       │    │   App       │     │
│  │ Server #1   │    │ Server #2   │     │
│  │ (Tomcat)    │    │ (Tomcat)    │     │
│  └─────────────┘    └─────────────┘     │
│         │                   │           │
└─────────┼───────────────────┼───────────┘
          │                   │
┌─────────┼──── DB層 ─────────┼───────────┐
│         ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐     │
│  │   Primary   │    │  Secondary  │     │
│  │   DB        │◄──►│     DB      │     │
│  │(PostgreSQL) │    │(PostgreSQL) │     │
│  └─────────────┘    └─────────────┘     │
│                                         │
│  ┌─────────────┐    ┌─────────────┐     │
│  │   Cache     │    │    Log      │     │
│  │  (Redis)    │    │    DB       │     │
│  │             │    │ (MongoDB)   │     │
│  └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────┘
```

### 2.2 論理構成

#### 2.2.1 アプリケーション構成
```
┌─────────────────────────────────────────────────────────┐
│                  フロントエンド                           │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Dashboard  │  │   User      │  │   Report    │    │
│  │    SPA      │  │  Management │  │   Module    │    │
│  │  (React)    │  │   Module    │  │  (Vue.js)   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
                       REST API
                          │
┌─────────────────────────────────────────────────────────┐
│                   API Gateway                           │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐ │
│  │  API Router / Load Balancer / Auth Filter          │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                  バックエンドサービス                      │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │    User     │  │    Data     │  │    Auth     │    │
│  │   Service   │  │   Service   │  │   Service   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Report    │  │   Batch     │  │    Log      │    │
│  │   Service   │  │   Service   │  │   Service   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 3. 機能方式設計

### 3.1 認証・認可方式

#### 3.1.1 認証フロー
```
Client                API Gateway           Auth Service         User DB
  │                       │                     │                 │
  │ 1. Login Request      │                     │                 │
  ├──────────────────────►│                     │                 │
  │                       │ 2. Authenticate     │                 │
  │                       ├────────────────────►│                 │
  │                       │                     │ 3. User Check   │
  │                       │                     ├────────────────►│
  │                       │                     │ 4. User Info    │
  │                       │                     │◄────────────────┤
  │                       │ 5. JWT Token        │                 │
  │                       │◄────────────────────┤                 │
  │ 6. JWT Token          │                     │                 │
  │◄──────────────────────┤                     │                 │
  │                       │                     │                 │
  │ 7. API Request + JWT  │                     │                 │
  ├──────────────────────►│                     │                 │
  │                       │ 8. Validate JWT     │                 │
  │                       ├────────────────────►│                 │
  │                       │ 9. User Claims      │                 │
  │                       │◄────────────────────┤                 │
  │                       │ 10. Forward Request │                 │
  │                       ├─────────────────────┼─────────────────┤
```

#### 3.1.2 認可方式（RBAC）
- **Role**: システム管理者、一般ユーザー、参照ユーザー
- **Permission**: Create、Read、Update、Delete、Execute
- **Resource**: ユーザー管理、データ管理、レポート、システム設定

### 3.2 データ処理方式

#### 3.2.1 CRUD操作フロー
```
Frontend              API Gateway           Service Layer         Data Layer
   │                       │                     │                   │
   │ 1. HTTP Request       │                     │                   │
   ├──────────────────────►│                     │                   │
   │                       │ 2. Route + Auth     │                   │
   │                       ├────────────────────►│                   │
   │                       │                     │ 3. Business Logic │
   │                       │                     │                   │
   │                       │                     │ 4. DB Operation   │
   │                       │                     ├──────────────────►│
   │                       │                     │ 5. Result         │
   │                       │                     │◄──────────────────┤
   │                       │ 6. Response         │                   │
   │                       │◄────────────────────┤                   │
   │ 7. HTTP Response      │                     │                   │
   │◄──────────────────────┤                     │                   │
```

#### 3.2.2 トランザクション管理
- **分散トランザクション**: Saga パターンの採用
- **整合性**: 結果的整合性（Eventual Consistency）
- **補償処理**: 各サービスでの補償アクション定義

### 3.3 バッチ処理方式

#### 3.3.1 バッチ処理アーキテクチャ
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Scheduler │    │   Batch     │    │   Data      │
│  (Cron Job) │───►│  Processor  │───►│  Storage    │
└─────────────┘    └─────────────┘    └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │    Log      │
                   │   Storage   │
                   └─────────────┘
```

#### 3.3.2 バッチ処理フロー
1. **スケジュール起動**: Cron による定時実行
2. **処理開始**: バッチ処理サービス起動
3. **データ読み込み**: 対象データの抽出
4. **データ処理**: ビジネスロジック実行
5. **結果保存**: 処理結果の保存
6. **ログ出力**: 処理ログの記録
7. **通知**: 完了・エラー通知

## 4. 非機能方式設計

### 4.1 性能方式

#### 4.1.1 キャッシュ戦略
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │    │  App Server │    │   Database  │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Request        │                   │
       ├──────────────────►│                   │
       │                   │ 2. Check Cache    │
       │                   │         │         │
       │                   │         ▼         │
       │                   │ ┌─────────────┐   │
       │                   │ │    Redis    │   │
       │                   │ │   (Cache)   │   │
       │                   │ └─────────────┘   │
       │                   │         │         │
       │                   │ 3. Cache Miss     │
       │                   ├──────────────────►│
       │                   │ 4. DB Result      │
       │                   │◄──────────────────┤
       │                   │ 5. Update Cache   │
       │                   │         │         │
       │ 6. Response       │         ▼         │
       │◄──────────────────┤ ┌─────────────┐   │
       │                   │ │    Redis    │   │
       │                   │ └─────────────┘   │
```

#### 4.1.2 負荷分散方式
- **ロードバランサー**: Round Robin + Health Check
- **セッション管理**: Redis によるセッション共有
- **データベース**: Read Replica による読み取り負荷分散

### 4.2 可用性方式

#### 4.2.1 冗長化構成
- **Webサーバー**: アクティブ・アクティブ構成
- **アプリケーションサーバー**: アクティブ・アクティブ構成
- **データベース**: プライマリ・セカンダリ構成

#### 4.2.2 ヘルスチェック
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│Load Balancer│    │ App Server  │    │  Database   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ Health Check      │                   │
       ├──────────────────►│                   │
       │                   │ DB Health Check   │
       │                   ├──────────────────►│
       │                   │ Status            │
       │                   │◄──────────────────┤
       │ Health Status     │                   │
       │◄──────────────────┤                   │
```

### 4.3 セキュリティ方式

#### 4.3.1 データ暗号化
- **転送時暗号化**: TLS 1.3
- **保存時暗号化**: AES-256
- **フィールドレベル暗号化**: 機密データ

#### 4.3.2 アクセス制御
- **ネットワークレベル**: ファイアウォール、VPN
- **アプリケーションレベル**: JWT + RBAC
- **データベースレベル**: ユーザー権限管理

## 5. データ方式設計

### 5.1 データ分散方式

#### 5.1.1 データベース分離
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │    │    Data     │    │    Log      │
│  Service    │    │   Service   │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User DB   │    │   Data DB   │    │   Log DB    │
│(PostgreSQL) │    │(PostgreSQL) │    │ (MongoDB)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

#### 5.1.2 データ同期方式
- **リアルタイム同期**: プライマリ・セカンダリ間のストリーミングレプリケーション
- **バッチ同期**: 日次データ整合性チェック
- **イベント同期**: Message Queue によるイベント駆動同期

### 5.2 バックアップ方式

#### 5.2.1 バックアップ戦略
- **フルバックアップ**: 日次実行
- **差分バックアップ**: 時間単位実行
- **ログバックアップ**: 継続実行

#### 5.2.2 リストア戦略
- **ポイントインタイムリカバリ**: 任意時点への復旧
- **部分リストア**: テーブル単位での復旧
- **クロスサイトリストア**: DR サイトでの復旧

## 6. 運用方式設計

### 6.1 監視方式

#### 6.1.1 監視アーキテクチャ
```
┌─────────────────────────────────────────────────────────┐
│                   Application                          │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Metrics    │  │    Logs     │  │   Traces    │    │
│  │ Collection  │  │ Collection  │  │ Collection  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Monitoring Platform                   │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Prometheus  │  │    ELK      │  │   Jaeger    │    │
│  │   Stack     │  │   Stack     │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    Alert Manager                       │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Email     │  │    Slack    │  │     SMS     │    │
│  │    Alert    │  │   Alert     │  │   Alert     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
```

#### 6.1.2 監視項目
- **システムメトリクス**: CPU、メモリ、ディスク、ネットワーク
- **アプリケーションメトリクス**: レスポンス時間、エラー率、スループット
- **ビジネスメトリクス**: ユーザー数、トランザクション数、成功率

### 6.2 ログ管理方式

#### 6.2.1 ログ収集
- **アプリケーションログ**: 構造化ログ（JSON形式）
- **アクセスログ**: Webサーバー・API Gateway
- **システムログ**: OS・ミドルウェアログ
- **監査ログ**: ユーザー操作・権限変更

#### 6.2.2 ログ分析
- **リアルタイム分析**: ストリーミング処理による即座の異常検知
- **バッチ分析**: 日次レポート・トレンド分析
- **インタラクティブ分析**: ダッシュボード・アドホック分析

### 6.3 デプロイ方式

#### 6.3.1 CI/CD パイプライン
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Source    │    │    Build    │    │    Test     │
│   Control   │───►│   & Test    │───►│   Deploy    │
│    (Git)    │    │  (Jenkins)  │    │  (Staging)  │
└─────────────┘    └─────────────┘    └─────────────┘
                                             │
                                             ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Production  │    │   Approve   │    │   Manual    │
│   Deploy    │◄───│  & Release  │◄───│    Test     │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
```

#### 6.3.2 デプロイ戦略
- **Blue-Green デプロイ**: 無停止デプロイメント
- **ローリングデプロイ**: 段階的インスタンス更新
- **カナリアデプロイ**: 小規模テスト後の段階展開

## 7. インターフェース方式

### 7.1 API設計方式

#### 7.1.1 REST API設計原則
- **RESTful**: リソース指向設計
- **ステートレス**: セッション状態の非保持
- **HATEOAS**: リンクによるナビゲーション
- **キャッシュ可能**: 適切なキャッシュヘッダー

#### 7.1.2 API バージョニング
- **URL パス**: `/api/v1/users`、`/api/v2/users`
- **ヘッダー**: `Accept: application/vnd.api+json;version=1`
- **互換性**: 後方互換性の維持

### 7.2 外部システム連携

#### 7.2.1 連携方式
- **同期連携**: REST API による即座のデータ交換
- **非同期連携**: Message Queue による疎結合連携
- **バッチ連携**: ファイル転送による大量データ交換

#### 7.2.2 エラーハンドリング
- **リトライ**: 指数バックオフによる再試行
- **サーキットブレーカー**: 障害の拡散防止
- **フォールバック**: 代替処理による継続運用

---

**注意**: このシステム方式設計書は、実装の指針となる重要な文書です。実装時は本設計に準拠し、変更時は影響分析を実施してください。